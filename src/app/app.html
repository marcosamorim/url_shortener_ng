<div class="page">
  <header class="header">
    <img class="logo" src="/logo.png" alt="rdrt logo" />
    <h1 class="title">URL Shortener</h1>
    <p class="subtitle">Paste a long URL, get a short one.</p>
    <div class="header-actions">
      @if (isLoggedIn()) {
        <div class="logged-pill logged-pill-quiet">
          <span class="status-dot"></span>
          Online
        </div>
        <button type="button" class="icon-btn icon-btn-ghost" (click)="openLogoutConfirm()">
          Log out
        </button>
      } @else {
        <button type="button" class="icon-btn icon-btn-ghost" (click)="openAuth()">
          Log in
        </button>
      }
    </div>
  </header>

  <main class="card">
    <!-- SHORTEN FORM (ALWAYS AVAILABLE) -->
    <form class="form" (ngSubmit)="onSubmit()">
      <label for="url" class="label">Long URL</label>

      <div class="input-row">
        <input
          id="url"
          name="url"
          type="url"
          [(ngModel)]="url"
          placeholder="https://example.com/very/long/link"
          class="input"
          [class.input-error]="error()"
          autocomplete="off"
        />

        <button type="submit" class="btn btn-primary" [disabled]="isLoading() || !url">
          @if (!isLoading()) {
            Shorten
          } @else {
            <span class="spinner"></span>
          }
        </button>
      </div>

      @if (error()) {
        <p class="error">{{ error() }}</p>
      }

      <button type="button" class="link-btn advanced-toggle" (click)="toggleAdvancedCreate()">
        @if (showAdvancedCreate) { Hide advanced options } @else { Show advanced options }
      </button>

      @if (showAdvancedCreate) {
        <div class="expiry-row">
          <label for="expiresAt" class="label">Expires at (optional)</label>
          <input
            id="expiresAt"
            name="expiresAt"
            type="text"
            [(ngModel)]="expiresAtInput"
            class="input input-small"
            autocomplete="off"
            placeholder="YYYY-MM-DD HH:mm"
          />
        </div>
      }
    </form>

    @if (result()) {
      <section class="result">
        <h2 class="result-title">Short URL</h2>

        <div class="result-main">
          <div class="result-text">
            <div class="result-row">
              <a
                class="short-url"
                [href]="result()!.short_url"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ result()!.short_url }}
              </a>

              <button type="button" class="icon-btn icon-btn-ghost" (click)="copyShortUrl()">
                Copy
              </button>

              <button type="button" class="icon-btn icon-btn-ghost" (click)="toggleQr()">
                @if (showQr()) { QR Off } @else { QR }
              </button>
            </div>

            <div class="meta">
              <div>
                <div class="meta-label">Original</div>
                <div class="meta-value original-url">{{ result()!.original_url }}</div>
              </div>
            </div>
          </div>

          @if (showQr()) {
            <div class="qr-container">
              <div class="qr-card" #qrCard>
                <div class="qr-url">{{ shortUrlLabel }}</div>

                <div class="qr-code-wrapper">
                  <qrcode
                    [qrdata]="result()!.short_url"
                    [width]="220"
                    [errorCorrectionLevel]="'H'"
                  ></qrcode>

                  <div class="qr-logo">
                    <img class="qr-logo-inner" src="/logo.png" alt="rdrt logo" />
                  </div>
                </div>
              </div>

              <div class="qr-actions">
                <button
                  type="button"
                  class="icon-btn icon-btn-ghost qr-action-btn"
                  (click)="downloadQrCard()"
                >
                  Download card
                </button>

                <button
                  type="button"
                  class="icon-btn icon-btn-ghost qr-action-btn"
                  (click)="copyQrCardToClipboard()"
                >
                  Copy card
                </button>
              </div>
            </div>
          }
        </div>
      </section>
    }

    @if (isLoggedIn()) {
      <section class="my-urls">
        <div class="my-urls-head">
          <div class="my-urls-actions">
            <div class="my-urls-left">
              <button type="button" class="icon-btn icon-btn-ghost" (click)="toggleMyUrls()">
                @if (myUrlsOpen()) { History · Hide } @else { History · Show }
              </button>
              @if (myUrlsOpen()) {
                <button
                  type="button"
                  class="icon-btn icon-btn-ghost"
                  (click)="refreshMyUrls()"
                  [disabled]="myUrlsLoading()"
                  aria-label="Refresh history"
                  title="Refresh"
                >
                  ↻
                </button>
              }
            </div>
            @if (myUrlsOpen()) {
              <button type="button" class="link-btn my-urls-meta" disabled>
                Page {{ myUrlsPage() }} / {{ myUrlsTotalPages }}
              </button>
            }
          </div>
        </div>

        @if (myUrlsOpen()) {
          <div class="my-urls-title">My History</div>

          @if (myUrlsLoading()) {
            <div class="my-urls-empty">Loading your URLs...</div>
          } @else if (myUrlsError()) {
            <div class="error">{{ myUrlsError() }}</div>
          } @else if (!myUrls().length) {
            <div class="my-urls-empty">No links yet. Create your first short URL above.</div>
          } @else {
            <div class="my-urls-list">
              @for (item of myUrls(); track item.code) {
                <div class="my-urls-item">
                  <div class="my-urls-top">
                    <div class="my-urls-main">
                      <a class="short-url" [href]="item.short_url" target="_blank" rel="noopener">
                        {{ item.short_url }}
                      </a>
                      <div class="my-urls-original">{{ item.original_url }}</div>
                    </div>
                    <div class="my-urls-stats">
                      <div>
                        <div class="meta-label">Clicks</div>
                        <div class="meta-value">{{ item.clicks }}</div>
                      </div>
                      <div>
                        <div class="meta-label">Created</div>
                        <div class="meta-value">{{ formatDate(item.created_at) }}</div>
                      </div>
                      <div>
                        <div class="meta-label">Status</div>
                        <div
                          class="meta-value status-text"
                          [class.status-text-active]="item.is_active"
                          [class.status-text-inactive]="!item.is_active"
                        >
                          {{ item.is_active ? 'Active' : 'Inactive' }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="my-urls-actions-row">
                    <button
                      type="button"
                      class="link-btn advanced-toggle"
                      (click)="toggleAdvancedItem(item.code)"
                    >
                      @if (openAdvanced[item.code]) { Hide options } @else { Show options }
                    </button>
                  </div>

                  @if (openAdvanced[item.code]) {
                    <div class="my-urls-advanced">
                      <button
                        type="button"
                        class="icon-btn icon-btn-ghost"
                        (click)="toggleActive(item)"
                        [disabled]="actionLoading[item.code]"
                      >
                        @if (item.is_active) { Deactivate } @else { Activate }
                      </button>
                      <div class="expiry-edit">
                        <div class="expiry-field">
                          <div class="meta-label">Expires at</div>
                          <input
                            type="text"
                            [ngModel]="getExpiryInput(item)"
                            (ngModelChange)="setExpiryInput(item.code, $event)"
                            class="input input-small"
                            autocomplete="off"
                            placeholder="YYYY-MM-DD HH:mm"
                          />
                          <div class="expiry-help">Leave blank for no expiry.</div>
                        </div>
                        <button
                          type="button"
                          class="icon-btn icon-btn-ghost"
                          (click)="saveExpiry(item)"
                          [disabled]="actionLoading[item.code]"
                        >
                          Save
                        </button>
                      </div>
                    </div>
                  }

                  @if (actionError[item.code]) {
                    <p class="error">{{ actionError[item.code] }}</p>
                  }
                </div>
              }
            </div>

            <div class="pagination">
              <button
                type="button"
                class="icon-btn icon-btn-ghost"
                (click)="prevMyUrlsPage()"
                [disabled]="myUrlsPage() <= 1"
              >
                Previous
              </button>
              <button
                type="button"
                class="icon-btn icon-btn-ghost"
                (click)="nextMyUrlsPage()"
                [disabled]="myUrlsPage() >= myUrlsTotalPages"
              >
                Next
              </button>
            </div>
          }
        }
      </section>
    }
  </main>

  <footer class="footer">Frontend: Angular · API: FastAPI</footer>

  @if (isAuthOpen()) {
    <div class="auth-overlay" (click)="closeAuth()">
      <aside class="auth-panel" (click)="$event.stopPropagation()">
        <div class="auth-panel-header">
          <div class="auth-panel-text">
            @if (isRegisterMode()) {
              <div class="auth-title">Create your account</div>
              <div class="auth-hint">Sign up to keep your links and access private stats.</div>
            } @else {
              <div class="auth-title">Welcome back</div>
              <div class="auth-hint">Log in to tie links to your account or create a new one.</div>
            }
          </div>
          <button type="button" class="icon-btn" (click)="closeAuth()" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>

        @if (!isLoggedIn()) {
          <div class="auth-tabs" role="tablist" aria-label="Auth mode">
            <button
              type="button"
              class="auth-tab"
              role="tab"
              [attr.aria-selected]="!isRegisterMode()"
              [class.auth-tab-active]="!isRegisterMode()"
              (click)="setAuthMode('login')"
            >
              Log in
            </button>
            <button
              type="button"
              class="auth-tab"
              role="tab"
              [attr.aria-selected]="isRegisterMode()"
              [class.auth-tab-active]="isRegisterMode()"
              (click)="setAuthMode('register')"
            >
              Sign up
            </button>
          </div>

          <form class="auth-form" (submit)="isRegisterMode() ? register() : login()">
            <div class="auth-field">
              <label class="label" for="email">Email</label>
              <input
                id="email"
                name="email"
                type="email"
                [(ngModel)]="email"
                (blur)="emailTouched = true"
                class="input"
                autocomplete="email"
                placeholder="you@example.com"
              />
              @if (emailTouched && email && !isValidEmail(email)) {
                <p class="error">Please enter a valid email.</p>
              }
            </div>

            <div class="auth-field">
              <label class="label" for="password">Password</label>
              <input
                id="password"
                name="password"
                type="password"
                [(ngModel)]="password"
                class="input"
                autocomplete="current-password"
                placeholder="••••••••"
              />
            </div>

            @if (isRegisterMode()) {
              <div class="auth-field">
                <label class="label" for="confirm-password">Confirm password</label>
                <input
                  id="confirm-password"
                  name="confirm-password"
                  type="password"
                  [(ngModel)]="confirmPassword"
                  class="input"
                  autocomplete="new-password"
                  placeholder="••••••••"
                />
              </div>
            }

            <button
              type="submit"
              class="icon-btn icon-btn-ghost auth-submit"
              [disabled]="authLoading() || !canSubmitAuth()"
            >
              @if (!authLoading()) {
                @if (isRegisterMode()) { Create account } @else { Continue }
              } @else {
                <span class="spinner"></span>
              }
            </button>

            @if (passwordsMismatch()) {
              <p class="error">Passwords do not match.</p>
            }

            @if (authError()) {
              <p class="error">{{ authError() }}</p>
            }
          </form>
        } @else {
          <div class="auth-logged">
            <div class="auth-logged-badge">
              <span class="auth-logged-icon">✓</span>
              Logged in
            </div>
            <button type="button" class="icon-btn icon-btn-ghost" (click)="logout()">
              Log out
            </button>
          </div>
        }
      </aside>
    </div>
  }

  @if (isLogoutOpen()) {
    <div class="auth-overlay" (click)="closeLogoutConfirm()">
      <aside class="auth-panel auth-panel-compact" (click)="$event.stopPropagation()">
        <div class="auth-panel-header">
          <div class="auth-panel-text">
            <div class="auth-title">Log out?</div>
            <div class="auth-hint">Links created while logged out won’t appear in your history.</div>
          </div>
        </div>

        <div class="logout-actions">
          <button type="button" class="icon-btn icon-btn-ghost" (click)="closeLogoutConfirm()">
            Stay logged in
          </button>
          <button type="button" class="icon-btn icon-btn-ghost auth-submit danger" (click)="logout()">
            Log out
          </button>
        </div>
      </aside>
    </div>
  }

  @if (toastMessage()) {
    <div class="toast">{{ toastMessage() }}</div>
  }
</div>
